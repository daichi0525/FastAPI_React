# エクセル VBA マクロ

```vb

'-------------------------------------------------------------------------
'-------------------------------------------------------------------------
オブジェクト名：Sheet1
Name：設定
'-------------------------------------------------------------------------
'-------------------------------------------------------------------------
Private Sub Worksheet_Change(ByVal Target As Range)

    ' E5セルの値が変更された場合に処理を行う
    If Target.Column = 5 And Target.row = 5 Then
        On Error GoTo handleError

        Application.Cursor = xlWait
        Application.StatusBar = "処理中です"
        Application.EnableCancelKey = xlDisabled
        Application.EnableEvents = False    'イベント発生無効化
        Application.ScreenUpdating = False  '描画の無効化

        '進捗管理シートを選択
        Worksheets(ChartSheet).Select

        '設定シートのE5セルの値を取得
        Dim setDate As String
        setDate = Worksheets(SettingSheet).Range("E5").Value

        ' 日付が有効であるか確認し、計画開始日を設定
        If IsDate(setDate) Then
            ActiveSheet.Range("DateArea").Value = setDate
        Else
            ActiveSheet.Range("DateArea").Value = DateSerial(Year(Date), 1, 1)
        End If

        ' ガンチャートの描画
        Call DrawPlan
        ' イナズマ線の描画
        Call DorwInazumaEx
        ' カラム表示位置初期化
        Call ColumnDisplayInit

handleError:
        ' 各種設定を元に戻す
        Application.EnableCancelKey = xlInterrupt
        Application.StatusBar = False
        Application.Cursor = xlDefault
        Application.EnableEvents = True     'イベント発生有効化
        Application.ScreenUpdating = True   '描画の有効化
    End If

End Sub

'-------------------------------------------------------------------------
'-------------------------------------------------------------------------
オブジェクト名：Sheet2
Name：進捗管理
'-------------------------------------------------------------------------
'-------------------------------------------------------------------------
Private Sub Worksheet_Activate()

    On Error GoTo handleError

    Application.EnableEvents = False    'イベント発生無効化
    Application.ScreenUpdating = False  '描画の無効化
    Application.Calculation = xlCalculationManual
    ProcessingMessage (True)   '処理中メッセージ表示

    ' 当日起点のイナズマ線を描画する
    Call DorwInazumaEx

handleError:
    Application.Calculation = xlCalculationAutomatic
    ProcessingMessage (False)   '処理中メッセージ消去
    Application.ScreenUpdating = True   '描画の有効化
    Application.EnableEvents = True     'イベント発生有効化
End Sub

'-------------------------------------------------------------------------
' セルの値が変更されたときに発生するイベント
'-------------------------------------------------------------------------
Private Sub Worksheet_Change(ByVal Target As Range)

    ' 対象外列（項番、担当）は無処理
    If Target.Column > 9 Or Target.Column = 1 Or Target.Column = 3 Then
        Exit Sub
    End If

On Error GoTo handleError
    Application.ScreenUpdating = False  '描画の無効化
    Application.EnableEvents = False    'イベント発生無効化
    Application.Calculation = xlCalculationManual

    ProcessingMessage (True)   '処理中メッセージ表示

    ActiveSheet.Unprotect

    Dim c As Range
    Dim arr() As String
    ReDim Preserve arr(0)

    For Each c In Target

        ' 処理済行はスキップ
        strNames = Filter(arr, c.row)
        If UBound(strNames) < 0 Then
            ' 日数より計画終了日を自動計算
            startDateColumn = ActiveSheet.Range(C_InputStartDatePlan).Column
            endDateColumn = ActiveSheet.Range(C_InputEndDatePlan).Column
            planDaysColumn = ActiveSheet.Range(C_PlanDays).Column

            ' 開始と終了の入替
            If c.Column = startDateColumn Or c.Column = endDateColumn Then
                If Cells(c.row, startDateColumn).Value <> "" And Cells(c.row, endDateColumn).Value <> "" Then
                    Call ChangeDate(c.row, startDateColumn, endDateColumn)
                    stDate = Cells(c.row, startDateColumn).Value
                    edDate = Cells(c.row, endDateColumn).Value
                    workDays = WorkingDayCalculation(stDate, edDate)
                    Cells(c.row, planDaysColumn).Value = workDays
                Else
                    Cells(c.row, planDaysColumn).Value = Empty
                End If
            End If

            ' 終了日の自動計算
            If c.Column = startDateColumn Or c.Column = planDaysColumn Then
                stDate = Cells(c.row, startDateColumn).Value
                days = Cells(c.row, planDaysColumn).Value
                edDate = DateAdd("d", days - 1, stDate)
                If stDate <> "" And days <> "" Then
                    workDays = WorkingDayCalculation(stDate, edDate)
                    cnt = days - workDays
                    While cnt > 0
                        edDate = DateAdd("d", cnt, edDate)
                        workDays = WorkingDayCalculation(stDate, edDate)
                        cnt = days - workDays
                    Wend
                    Cells(c.row, endDateColumn).Value = edDate
                End If
            End If

            ' 日付変更時の処理
            If c.row > 3 Then
                Call DateChange(c)
            End If

            ' 処理済行に追加
            arr(UBound(arr)) = c.row
        End If
    Next c
    ' 当日起点のイナズマ線を描画する
    Call DorwInazumaEx

    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFormattingCells:=True, AllowFormattingColumns:=True, _
        AllowFormattingRows:=True, AllowFiltering:=True

handleError:
    ProcessingMessage (False)   '処理中メッセージ消去
    Application.Calculation = xlCalculationAutomatic
    Application.EnableEvents = True     'イベント発生有効化
    Application.ScreenUpdating = True   '描画の有効化
End Sub

'-------------------------------------------------------------------------
'-------------------------------------------------------------------------
オブジェクト名：Sheet3
Name：進捗詳細
'-------------------------------------------------------------------------
'-------------------------------------------------------------------------
Option Explicit
Public Flag As Boolean

Private Sub Worksheet_Activate()

On Error GoTo handleError
    ProcessingMessage (True)   '処理中メッセージ表示
    Application.EnableEvents = False    'イベント発生無効化
    Application.ScreenUpdating = False  '描画の無効化
    Application.Calculation = xlCalculationManual

    ' 保護解除
    Worksheets(InfoSheet).Unprotect

    ' 書式のコピー
    Call SelectionCopy

handleError:
    ' 保護設定
    Worksheets(InfoSheet).Select
    Columns("B:H").Select
    Selection.Locked = True
    Range("A1").Select
    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True
    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True   '描画の有効化
    Application.EnableEvents = True     'イベント発生有効化
    ProcessingMessage (False)   '処理中メッセージ消去
End Sub

'-------------------------------------------------------------------------
' セルの値が変更されたときに発生するイベント
'-------------------------------------------------------------------------
Private Sub Worksheet_Change(ByVal Target As Range)

    ' 列ヘッダ部の修正は無処理
    If Target.Column < 10 Then
        Exit Sub
    End If

On Error GoTo handleError
    ProcessingMessage (True)   '処理中メッセージ表示
    Application.ScreenUpdating = False  '描画の無効化
    Application.EnableEvents = False    'イベント発生無効化

    ' 進捗変更処理
    Call ProgressChange(Target)

handleError:
    ProcessingMessage (False)   '処理中メッセージ消去
    Application.EnableEvents = True     'イベント発生有効化
    Application.ScreenUpdating = True   '描画の有効化
End Sub

'-------------------------------------------------------------------------
'-------------------------------------------------------------------------
オブジェクト名：Config
'-------------------------------------------------------------------------
'-------------------------------------------------------------------------
'バージョン
Global Const Version = "Ver. 1.1.8"
'メニュー名称
Global Const g_cnsTITLE = "taskplan"

'シート名称
Global Const ChartSheet = "進捗管理"
Global Const InfoSheet = "進捗詳細"
Global Const SettingSheet = "設定"

' 名前の定義
Global Const C_DateArea = "DateArea"                      '日付起点
Global Const C_EndDate = "EndDate"                        'ガンチャート最終日
Global Const C_InputEndDate = "InputEndDate"              '実績終了日
Global Const C_InputEndDatePlan = "InputEndDatePlan"      '計画終了日
Global Const C_InputStartDate = "InputStartDate"          '実績開始日
Global Const C_InputStartDatePlan = "InputStartDatePlan"  '実績開始日
Global Const C_No = "No"                                  '項番
Global Const C_ProgressRate = "ProgressRate"              '進捗率
Global Const C_StartTaskRow = "StartTaskRow"              'タスク開始行
Global Const C_Manager = "Manager"                        '担当
Global Const C_PlanDays = "PlanDays"                      '計画日数

' はい、いいえ定数
Global Const C_YES = "はい"
Global Const C_NONE = "いいえ"

'-------------------------------------------------------------------------
'-------------------------------------------------------------------------
オブジェクト名：Module1
'-------------------------------------------------------------------------
'-------------------------------------------------------------------------
'変数を宣言しないと使えませんという命令
'Option Explicit

' 立ち上げ時自動実行処理
Private Sub Auto_Open()

    On Error GoTo handleError

    Application.Cursor = xlWait
    Application.StatusBar = "処理中です"
    Application.EnableCancelKey = xlDisabled
    Application.EnableEvents = False    'イベント発生無効化

    ' ツールバーの追加
    Call AddToolber

    ' 図形消去
    Call ClearShapes

    ' 進捗管理シートを選択
    Worksheets(ChartSheet).Select

    ' バージョンの表示
    ActiveSheet.Range("D1").Value = Version

    ' 設定シートのE5セルの値を取得し、計画開始日を設定
    Dim setDate As String
    setDate = Worksheets(SettingSheet).Range("E5").Value
    If IsDate(setDate) Then
        ActiveSheet.Range("DateArea").Value = setDate
    Else
        ActiveSheet.Range("DateArea").Value = DateSerial(Year(Date), 1, 1)
    End If

    ' 進捗率の直接入力 対応
    Call UnprotectActiveWorkbook
    Call UnprotectChartSheet

    If Worksheets(SettingSheet).Range("E10").Value = C_YES Then
        '進捗率 直接入力
        Call ProgressUnLock
        '「進捗詳細」シート 非表示
        Call InfoSheetNoneDisplay
    Else
        Call ProgressLock
        '「進捗詳細」シート 表示
        Call InfoSheetDisplay
    End If

handleError:
    ' ガンチャートの描画
    Call DrawPlan
    ' イナズマ線の描画
    Call DorwInazumaEx
    ' カラム表示位置初期化
    Call ColumnDisplayInit

    ' 進捗率直接入力対応
    Call ProtectChartSheet
    Call ProtectActiveWorkbook

    Application.EnableEvents = True     'イベント発生有効化
    Application.EnableCancelKey = xlInterrupt
    Application.StatusBar = False
    Application.Cursor = xlDefault
End Sub

' 閉じる時の自動実行処理
Private Sub Auto_Close()

On Error GoTo handleError
    Application.EnableEvents = False    'イベント発生無効化

    Dim xlAPP As Application
    Dim objBar As CommandBar

    ' 図形消去
    Call ClearShapes

    ' 進捗管理シート選択
    Worksheets(ChartSheet).Select

    ' ﾂｰﾙﾊﾞｰｵﾌﾞｼﾞｪｸﾄを取得する
    Set objBar = xlAPP.CommandBars(g_cnsTITLE)

    ' ﾂｰﾙﾊﾞｰを削除する
    objBar.Delete

handleError:
    ' ｵﾌﾞｼﾞｪｸﾄを廃棄
    Set objBar = Nothing
    Application.EnableEvents = True     'イベント発生有効化
End Sub

Sub goo()
    Application.EnableEvents = True     'イベント発生有効化
    Application.ScreenUpdating = True   '描画の有効化
End Sub

'-------------------------------------------------------------------------
' アクティブシートの工程表を再描画する
'-------------------------------------------------------------------------
Sub DrawPlan()

'On Error GoTo handleError

    ProcessingMessage (True)   '処理中メッセージ表示

    Worksheets(ChartSheet).Unprotect
    Worksheets(ChartSheet).Select

    Dim task As Range
    Set task = Range("StartTaskRow")
    Worksheets(task.Parent.Name).Activate ' 1 番目のシートをアクティブ

    Dim cell As Range
    Set cell = Selection

    Application.EnableEvents = False    'イベント発生無効化
    Application.ScreenUpdating = False  '描画の無効化

    ActiveSheet.Outline.ShowLevels RowLevels:=0, ColumnLevels:=2

    Call ClearShapes

    Dim InputEndDatePlan As Range
    Dim InputStartDatePlan As Range
    Dim InputStartDate As Range
    Dim InputEndDate As Range

    Set InputStartDate = Range("InputStartDate")
    Set InputEndDate = Range("InputEndDate")
    Set InputStartDatePlan = Range("InputStartDatePlan")
    Set InputEndDatePlan = Range("InputEndDatePlan")

    '進捗率
    Dim rate As Range: Set rate = Range("ProgressRate")

    '項番
    Dim No As Range: Set No = Range("No")

    Dim r As Integer
    Dim c As Integer
    r = No.row
    c = No.Column

    Do While Cells(r, No.Column) <> ""

        Dim c1 As Integer
        Dim c2 As Integer
        Dim Today As Integer

        '項目が入力されている行を処理する
        If Cells(r, task.Column) <> "" Then
            '計画日(開始、終了)が入力されていない場合は描画しない
            If Cells(r, InputStartDatePlan.Column).Value <> "" And Cells(r, InputEndDatePlan.Column).Value <> "" Then
                c1 = 0
                c2 = 0
                Today = 0

                '計画日が逆転していたら入れ替える
                Call ChangeDate(r, InputStartDatePlan.Column, InputEndDatePlan.Column)

                Call getDateColumn(Cells(r, InputStartDatePlan.Column).Value, Cells(r, InputEndDatePlan.Column).Value, c1, c2, Today)
                Call DrowPlan(r, c1, c2)
                '終了日
                endStrText = startStrText = ""
                If Worksheets(SettingSheet).Range("E7").Value = C_YES Then
                    endStrText = Format(Cells(r, InputEndDatePlan.Column).Value, "m/d") & "　"
                    startStrText = Format(Cells(r, InputStartDatePlan.Column).Value, "m/d")
                End If
                cc2 = c2
                cc1 = c1

                '進捗入力で実績開始が未入力の場合、実績開始を当日にする
                '進捗率0％の場合は実績開始日に当日を設定しない
                If Cells(r, InputStartDate.Column).Value = "" And Cells(r, rate.Column).Value <> "" And Cells(r, rate.Column).Value <> 0 Then
                    Cells(r, InputStartDate.Column).Value = Date
                End If

                '実績 > 当日の場合当日にする
                If Cells(r, InputStartDate.Column).Value > Date Then
                    Cells(r, InputStartDate.Column).Value = Date
                End If
                If Cells(r, InputEndDate.Column).Value > Date Then
                    Cells(r, InputEndDate.Column).Value = Date
                End If

                '実績日が逆転していたら入れ替える
                Call ChangeDate(r, InputStartDate.Column, InputEndDate.Column)

                '進捗100%で実績終了が未入力の場合、実績終了を当日にする
                If Cells(r, InputEndDate.Column).Value = "" And Cells(r, rate.Column).Value <> "" And Cells(r, rate.Column).Value >= 1 Then
                    Cells(r, InputEndDate.Column).Value = Date
                End If

                '着手後、実績終了未入力の場合は終了日を当日として描画する
                InputEnd = Cells(r, InputEndDate.Column).Value
                If Cells(r, InputStartDate.Column).Value <> "" And Cells(r, InputStartDate.Column).Value <= Date And InputEnd = "" Then
                    InputEnd = Date
                End If

                '実績描画
                If Cells(r, InputStartDate.Column).Value <> "" And InputEnd <> "" Then
                    c1 = 0
                    c2 = 0
                    Call getDateColumn(Cells(r, InputStartDate.Column).Value, InputEnd, c1, c2, Today)
                    Call DrowPerformance(r, c1, c2)
                    '終了日
                    If Cells(r, InputEndDatePlan.Column).Value < InputEnd Then
                        cc2 = c2
                        If Worksheets(SettingSheet).Range("E7").Value = C_YES Then
                            endStrText = Format(InputEnd, "m/d") & "　"
                        End If
                    End If
                    If Cells(r, InputStartDate.Column).Value < Cells(r, InputStartDatePlan.Column).Value Then
                        cc1 = c1
                        If Worksheets(SettingSheet).Range("E7").Value = C_YES Then
                            startStrText = Format(Cells(r, InputStartDate.Column).Value, "m/d")
                        End If
                    End If
                End If

                'タスク名をテキスト
                Dim rr As Range
                Dim row As Long
                row = r
                shpName = "taskText" & row
                Set shp = ActiveSheet.Shapes(shpName)
                If shp IsNot Nothing Then
                    shp.Delete
                End If
                Set rr = Range(Cells(row, cc2), Cells(row, cc2 + 1))
                ActiveSheet.Shapes.AddTextbox(msoShapeRectangle, rr.Left + rr.Width / 2, rr.Top, 500, rr.Height).Select
                Selection.ShapeRange.Name = shpName

                If Worksheets(SettingSheet).Range("E6").Value = C_YES Then
                    If Worksheets(SettingSheet).Range("E7").Value = C_YES Then
                        Selection.ShapeRange.TextFrame.Characters.Text = endStrText & Cells(row, 2).Value
                    Else
                        Selection.ShapeRange.TextFrame.Characters.Text = Cells(row, 2).Value
                    End If
                Else
                    If Worksheets(SettingSheet).Range("E7").Value = C_YES Then
                        Selection.ShapeRange.TextFrame.Characters.Text = endStrText
                    End If
                End If
                Selection.ShapeRange.TextFrame.HorizontalAlignment = xlHAlignLeft
                Selection.ShapeRange.TextFrame.Characters.Font.Size = 9
                Selection.ShapeRange.Characters.Font.Bold = True
                Selection.ShapeRange.Line.Visible = msoFalse
                Selection.ShapeRange.Fill.Visible = msoFalse

                shpName = "startDateText" & row
                Set shp = ActiveSheet.Shapes(shpName)
                If shp IsNot Nothing Then
                    shp.Delete
                End If

                Dim DateArea As Range
                Set DateArea = Range("DateArea")

                If Worksheets(SettingSheet).Range("E7").Value = C_YES Then
                    If cc1 - 3 > DateArea.Column Then
                        Set rr = Range(Cells(row, cc1 - 4), Cells(row, cc1))
                        ActiveSheet.Shapes.AddTextbox(msoShapeRectangle, rr.Left + rr.Width / 3, rr.Top, 40, rr.Height).Select
                        Selection.ShapeRange.Name = shpName

                        Selection.ShapeRange.TextFrame.Characters.Text = startStrText
                        Selection.ShapeRange.TextFrame.HorizontalAlignment = xlHAlignRight
                        Selection.ShapeRange.Characters.Font.Size = 9
                        Selection.ShapeRange.Characters.Font.Bold = True
                        Selection.ShapeRange.Line.Visible = msoFalse
                        Selection.ShapeRange.Fill.Visible = msoFalse
                    End If
                End If

            Else

                ' 計画開始のみ入力の場合、マイルストーン表示
                If Cells(r, InputStartDatePlan.Column).Value <> "" Then
                    c1 = 0
                    c2 = 0
                    Today = 0
                    Call getDateColumn(Cells(r, InputStartDatePlan.Column).Value, Cells(r, InputStartDatePlan.Column).Value, c1, c2, Today)
                    Call DrowMilestone(r, c1)
                End If

                ' 計画終了のみ入力の場合、マイルストーン表示
                If Cells(r, InputEndDatePlan.Column).Value <> "" Then
                    c1 = 0
                    c2 = 0
                    Today = 0
                    Call getDateColumn(Cells(r, InputEndDatePlan.Column).Value, Cells(r, InputEndDatePlan.Column).Value, c1, c2, Today)
                    Call DrowMilestone(r, c1)
                End If

            End If
        Else
            ' タスク未入力の場合、進捗率をクリア
        End If

        ' 進捗100%でない場合、実績終了をクリア
        If Cells(r, InputEndDate.Column).Value <> "" And Cells(r, rate.Column).Value < 1 Then
            Cells(r, InputEndDate.Column).Value = ""
        End If

        r = r + 1
    Loop

    ' イナズマ線を描画する
    Call DorwInazuma(Today)

    cell.Activate

    ' シートの左端にくる列番号を設定する
    ActiveWindow.ScrollColumn = Today - 7

    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFormattingCells:=True, AllowFormattingColumns:=True, _
        AllowFormattingRows:=True, AllowFiltering:=True

handleError:
    Application.EnableEvents = True     'イベント発生有効化
    Application.ScreenUpdating = True   '描画の有効化
    Call ShapesZOrder
    ProcessingMessage (False)   '処理中メッセージ消去
End Sub

'-------------------------------------------------------------------------
' アクティブシートの該当行の工程表を再描画する
'-------------------------------------------------------------------------
Sub DrawPlanEx(row)

'On Error GoTo handleError

    Dim task As Range
    Set task = Range("StartTaskRow")
    Worksheets(task.Parent.Name).Activate ' 1 番目のシートをアクティブ

    Dim cell As Range
    Set cell = Selection

    ActiveSheet.Outline.ShowLevels RowLevels:=0, ColumnLevels:=2

    On Error Resume Next
    Dim shpName As String
    shpName = "Plan" & row
    Set shp = ActiveSheet.Shapes(shpName)
    If shp IsNot Nothing Then
        shp.Delete
    End If
    shpName = "Performance" & row
    Set shp = ActiveSheet.Shapes(shpName)
    If shp IsNot Nothing Then
        shp.Delete
    End If
    shpName = "Milestone" & row
    Set shp = ActiveSheet.Shapes(shpName)
    If shp IsNot Nothing Then
        shp.Delete
    End If

    ' マイルストーンテキスト削除
    shpName = "MilestoneName" & row
    Set shp = ActiveSheet.Shapes(shpName)
    If shp IsNot Nothing Then
        shp.Delete
    End If

    ' タスク名をテキスト
    shpName = "taskText" & row
    Set shp = ActiveSheet.Shapes(shpName)
    If shp IsNot Nothing Then
        shp.Delete
    End If
    shpName = "startDateText" & row
    Set shp = ActiveSheet.Shapes(shpName)
    If shp IsNot Nothing Then
        shp.Delete
    End If

    Dim InputEndDatePlan As Range
    Dim InputStartDatePlan As Range
    Dim InputStartDate As Range
    Dim InputEndDate As Range

    Set InputStartDate = Range("InputStartDate")
    Set InputEndDate = Range("InputEndDate")
    Set InputStartDatePlan = Range("InputStartDatePlan")
    Set InputEndDatePlan = Range("InputEndDatePlan")

    '進捗率
    Dim rate As Range: Set rate = Range("ProgressRate")

    '項番
    Dim No As Range: Set No = Range("No")

    Dim r As Integer
    Dim c As Integer
    r = row

    Dim c1 As Integer
    Dim c2 As Integer
    Dim Today As Integer

    '項目が入力されている行を処理する
    If Cells(r, task.Column) <> "" Then
        '計画日(開始、終了)が入力されていない場合は描画しない
        If Cells(r, InputStartDatePlan.Column).Value <> "" And Cells(r, InputEndDatePlan.Column).Value <> "" Then
            c1 = 0
            c2 = 0
            Today = 0

            '計画日が逆転していたら入れ替える
            Call ChangeDate(r, InputStartDatePlan.Column, InputEndDatePlan.Column)

            Call getDateColumn(Cells(r, InputStartDatePlan.Column).Value, Cells(r, InputEndDatePlan.Column).Value, c1, c2, Today)
            Call DrowPlan(r, c1, c2)
            '終了日
            endStrText = startStrText = ""
            If Worksheets(SettingSheet).Range("E7").Value = C_YES Then
                endStrText = Format(Cells(r, InputEndDatePlan.Column).Value, "m/d") & "　"
                startStrText = Format(Cells(r, InputStartDatePlan.Column).Value, "m/d")
            End If
            cc2 = c2
            cc1 = c1

            '進捗入力で実績開始が未入力の場合、実績開始を当日にする
            '進捗率0％の場合は実績開始日に当日を設定しない
            If Cells(r, InputStartDate.Column).Value = "" And Cells(r, rate.Column).Value <> "" And Cells(r, rate.Column).Value <> 0 Then
                Cells(r, InputStartDate.Column).Value = Date
            End If

            '実績 > 当日の場合当日にする
            If Cells(r, InputStartDate.Column).Value > Date Then
                Cells(r, InputStartDate.Column).Value = Date
            End If
            If Cells(r, InputEndDate.Column).Value > Date Then
                Cells(r, InputEndDate.Column).Value = Date
            End If
            '実績日が逆転していたら入れ替える
            Call ChangeDate(r, InputStartDate.Column, InputEndDate.Column)

            '進捗100%で実績終了が未入力の場合、実績終了を当日にする
            If Cells(r, InputEndDate.Column).Value = "" And Cells(r, rate.Column).Value <> "" And Cells(r, rate.Column).Value >= 1 Then
                Cells(r, InputEndDate.Column).Value = Date
            End If

            '着手後、実績終了未入力の場合は終了日を当日として描画する
            InputEnd = Cells(r, InputEndDate.Column).Value
            If Cells(r, InputStartDate.Column).Value <> "" And Cells(r, InputStartDate.Column).Value <= Date And InputEnd = "" Then
                InputEnd = Date
            End If

            '実績描画
            If Cells(r, InputStartDate.Column).Value <> "" And InputEnd <> "" Then
                c1 = 0
                c2 = 0
                Call getDateColumn(Cells(r, InputStartDate.Column).Value, InputEnd, c1, c2, Today)
                Call DrowPerformance(r, c1, c2)
                '終了日
                If Cells(r, InputEndDatePlan.Column).Value < InputEnd Then
                    cc2 = c2
                    If Worksheets(SettingSheet).Range("E7").Value = C_YES Then
                        endStrText = Format(InputEnd, "m/d") & "　"
                    End If
                End If
                If Cells(r, InputStartDate.Column).Value < Cells(r, InputStartDatePlan.Column).Value Then
                    cc1 = c1
                    If Worksheets(SettingSheet).Range("E7").Value = C_YES Then
                        startStrText = Format(Cells(r, InputStartDate.Column).Value, "m/d")
                    End If
                End If

            End If

            'タスク名をテキスト
            Dim rr As Range

            shpName = "taskText" & row
            Set shp = ActiveSheet.Shapes(shpName)
            If shp IsNot Nothing Then
                shp.Delete
            End If

            Set rr = Range(Cells(row, cc2), Cells(row, cc2 + 1))
            ActiveSheet.Shapes.AddTextbox(msoShapeRectangle, rr.Left + rr.Width / 2, rr.Top, 500, rr.Height).Select
            Selection.ShapeRange.Name = shpName

            If Worksheets(SettingSheet).Range("E6").Value = C_YES Then
                If Worksheets(SettingSheet).Range("E7").Value = C_YES Then
                    Selection.ShapeRange.TextFrame.Characters.Text = endStrText & Cells(row, 2).Value
                Else
                    Selection.ShapeRange.TextFrame.Characters.Text = Cells(row, 2).Value
                End If
            Else
                If Worksheets(SettingSheet).Range("E7").Value = C_YES Then
                    Selection.ShapeRange.TextFrame.Characters.Text = endStrText
                End If
            End If
            Selection.ShapeRange.TextFrame.HorizontalAlignment = xlHAlignLeft
            Selection.ShapeRange.Characters.Font.Size = 9
            Selection.ShapeRange.Characters.Font.Bold = True
            Selection.ShapeRange.Line.Visible = msoFalse
            Selection.ShapeRange.Fill.Visible = msoFalse

            shpName = "startDateText" & row
            Set shp = ActiveSheet.Shapes(shpName)
            If shp IsNot Nothing Then
                shp.Delete
            End If

            Dim DateArea As Range
            Set DateArea = Range("DateArea")

            If Worksheets(SettingSheet).Range("E7").Value = C_YES Then
                If cc1 - 3 > DateArea.Column Then
                    Set rr = Range(Cells(row, cc1 - 4), Cells(row, cc1))
                    ActiveSheet.Shapes.AddTextbox(msoShapeRectangle, rr.Left + rr.Width / 3, rr.Top, 40, rr.Height).Select
                    Selection.ShapeRange.Name = shpName

                    Selection.ShapeRange.TextFrame.Characters.Text = startStrText
                    Selection.ShapeRange.TextFrame.HorizontalAlignment = xlHAlignRight
                    Selection.ShapeRange.Characters.Font.Size = 9
                    Selection.ShapeRange.Characters.Font.Bold = True
                    Selection.ShapeRange.Line.Visible = msoFalse
                    Selection.ShapeRange.Fill.Visible = msoFalse
                End If
            End If


        Else

            ' 計画開始のみ入力の場合、マイルストーン表示
            If Cells(r, InputStartDatePlan.Column).Value <> "" Then
                c1 = 0
                c2 = 0
                Today = 0
                Call getDateColumn(Cells(r, InputStartDatePlan.Column).Value, Cells(r, InputStartDatePlan.Column).Value, c1, c2, Today)
                Call DrowMilestone(r, c1)
            End If

            ' 計画終了のみ入力の場合、マイルストーン表示
            If Cells(r, InputEndDatePlan.Column).Value <> "" Then
                c1 = 0
                c2 = 0
                Today = 0
                Call getDateColumn(Cells(r, InputEndDatePlan.Column).Value, Cells(r, InputEndDatePlan.Column).Value, c1, c2, Today)
                Call DrowMilestone(r, c1)
            End If

        End If
    Else
        ' タスク未入力の場合、進捗率をクリア
    End If

    ' 進捗100%でない場合、実績終了をクリア
    If Cells(r, InputEndDate.Column).Value <> "" And Cells(r, rate.Column).Value < 1 Then
        Cells(r, InputEndDate.Column).Value = ""
    End If

handleError:
    ' コメント、テキストを最前面へ
    Call ShapesZOrder
End Sub

'--------------------------------------------------------------
'機能：引数が配列か判定し、配列の場合は空かどうかも判定する
'戻り値：判定結果（1:配列 / 0:空の配列 / -1:配列ではない
' 2022.05.09 Add
'--------------------------------------------------------------
Public Function isArrayEx(varArray As Variant) As Long
On Error GoTo ERROR_
    If IsArray(varArray) Then
        isArrayEx = IIf(UBound(varArray) >= 0, 1, 0)
    Else
        isArrayEx = -1
    End If

    Exit Function

ERROR_:
    If Err.Number = 9 Then
        isArrayEx = 0
    Else
        '想定外エラー
    End If
End Function


'-------------------------------------------------------------------------
' 日付が変更された時の処理
'-------------------------------------------------------------------------
Sub DateChange(ByVal Target As Range)

    ' 現在のセル位置を記憶
    selCol = ActiveCell.Column
    selRow = ActiveCell.row

    Dim rate As Range: Set rate = Range("ProgressRate")
    Dim InputStartDatePlan As Range: Set InputStartDatePlan = Range("InputStartDatePlan")
    Dim InputEndDatePlan As Range: Set InputEndDatePlan = Range("InputEndDatePlan")
    Dim InputStartDate As Range: Set InputStartDate = Range("InputStartDate")
    Dim InputEndDate As Range: Set InputEndDate = Range("InputEndDate")
    Dim StartTaskRow As Range: Set StartTaskRow = Range("StartTaskRow")
    Dim DateArea As Range: Set DateArea = Range("DateArea")
    Dim PlanDays As Range: Set PlanDays = Range(C_PlanDays)

    Select Case Target.Column
        ' Task名列は無処理にする
        Case rate.Column, InputStartDatePlan.Column, InputEndDatePlan.Column, InputStartDate.Column, InputEndDate.Column, StartTaskRow.Column, PlanDays.Column
            ' 工程の描画
            Call DrawPlanEx(Target.row)
            ' 実績変更時はイナズマ線描画不要
            If False Then
                If Target.Column <> InputStartDate.Column And Target.Column <> InputEndDate.Column Then
                    ' イナズマ線の描画
                    Call DorwInazumaEx
                End If
            End If
        Case DateArea.Column
            If False Then
                Call DrawPlan
                ' イナズマ線の描画
                Call DorwInazumaEx
            End If
    End Select
End Sub

'-------------------------------------------------------------------------
' アクティブシート上の図形を一括削除する
'-------------------------------------------------------------------------
Sub ClearShapes()
  Dim shp As Shape

  ' すべての図形を削除
  For Each shp In Worksheets(ChartSheet).Shapes
    If shp.Type <> msoComment Then shp.Delete
  Next shp
End Sub

'-------------------------------------------------------------------------
' アクティブシート上の図形を再描画する
'-------------------------------------------------------------------------
Sub RefreshShapes()
  Dim shp As Shape

  ' 図形を再描画
  For Each shp In ActiveSheet.Shapes
    shp.Refresh
  Next shp
End Sub

'-------------------------------------------------------------------------
' コメント、テキストボックスを最前面に設定する
'-------------------------------------------------------------------------
Sub ShapesZOrder()
  Dim shp As Shape

  ' コメント、テキストボックスを最前面に設定
  For Each shp In ActiveSheet.Shapes
    If shp.Type = msoTextBox Or shp.Type = msoComment Then
      shp.ZOrder msoBringToFront
    End If
  Next shp
End Sub

'-------------------------------------------------------------------------
' 指定された開始日/終了日の開始カラム/終了カラムを取得する
'-------------------------------------------------------------------------
Sub getDateColumn(startdate, endDate, startColumn, endColumn, Today)

    Dim DateArea As Range
    Set DateArea = Range("DateArea")
    Dim endDateCell As Range
    Set endDateCell = Range("EndDate")

    If endDate < DateArea Then
        startColumn = DateArea.Column - 1
        endColumn = DateArea.Column - 1
    Else
        startColumn = startdate - DateArea + DateArea.Column
        endColumn = endDate - DateArea + DateArea.Column
    End If

    Today = Date - DateArea + DateArea.Column

    If startColumn < DateArea.Column Then
        startColumn = DateArea.Column - 1
    End If
    If endColumn < DateArea.Column Then
        endColumn = DateArea.Column - 1
    End If
    If Today < DateArea.Column Then
        Today = endDateCell.Column + 1
    End If

    If startColumn > endDateCell.Column Then
       startColumn = endDateCell.Column + 1
    End If
    If endColumn > endDateCell.Column Then
        endColumn = endDateCell.Column + 1
    End If

    If Today > endDateCell.Column Then
        Today = endDateCell.Column + 1
    End If

    If startColumn < DateArea.Column And endColumn >= DateArea.Column Then
        startColumn = DateArea.Column
    End If
    If startColumn <= endDateCell.Column And endColumn > endDateCell.Column Then
        endColumn = endDateCell.Column
    End If
End Sub

'-------------------------------------------------------------------------
' 計画工程を描画する
'-------------------------------------------------------------------------
Sub DrowPlan(row, startColumn, endColumn)

    On Error Resume Next

    '描画範囲外
    If IsDrownExit(startColumn, endColumn) Then
        Exit Sub
    End If

    '計画工程の削除
    Dim shpName As String
    shpName = "Plan" & row
    Set shp = ActiveSheet.Shapes(shpName)
    If shp IsNot Nothing Then
        shp.Delete
    End If

    'マイルストーンの削除
    shpName = "Milestone" & row
    Set shp = ActiveSheet.Shapes(shpName)
    If shp IsNot Nothing Then
        shp.Delete
    End If

    'マイルストーンテキスト削除
    shpName = "MilestoneName" & row
    Set shp = ActiveSheet.Shapes(shpName)
    If shp IsNot Nothing Then
        shp.Delete
    End If

    Dim r As Range
    Set r = Range(Cells(row, startColumn), Cells(row, endColumn))

    '計画工程描画
    ActiveSheet.Shapes.AddLine(r.Left, r.Top + r.Height / 4 + 3, r.Left + r.Width, r.Top + r.Height / 4 + 3).Select
    Selection.ShapeRange.Name = shpName
    With Selection.ShapeRange.Line
        .ForeColor.RGB = RGB(100, 149, 237) ' rgbCornflowerBlue
        .Transparency = 0#
        .Style = 1
        .BeginArrowheadStyle = 1
        .EndArrowheadStyle = 1
        .Weight = r.Height / 2
    End With

    Set shp = Nothing
End Sub

'-------------------------------------------------------------------------
' 実績工程を描画する
'-------------------------------------------------------------------------
Sub DrowPerformance(row, startColumn, endColumn)

    On Error Resume Next

    '描画範囲外
    If IsDrownExit(startColumn, endColumn) Then
        Exit Sub
    End If

    '実績工程の削除
    Dim shpName As String
    shpName = "Performance" & row
    Set shp = ActiveSheet.Shapes(shpName)
    If shp IsNot Nothing Then
        shp.Delete
    End If

    Dim r As Range
    Set r = Range(Cells(row, startColumn), Cells(row, endColumn))

    '実績工程描画
    ActiveSheet.Shapes.AddLine(r.Left, r.Top + r.Height - r.Height / 5 - 3, r.Left + r.Width, r.Top + r.Height - r.Height / 5 - 3).Select
    Selection.ShapeRange.Name = shpName
    With Selection.ShapeRange.Line
        .ForeColor.RGB = RGB(0, 0, 128) ' rgbNavy
        .Transparency = 0.2
        .Style = 1
        .BeginArrowheadStyle = 1
        .EndArrowheadStyle = 1
        .Weight = r.Height / 2
    End With

    Set shp = Nothing
    Set r = Nothing
End Sub

'-------------------------------------------------------------------------
' マイルストーンを描画する
' 2022.2.8 追加
'-------------------------------------------------------------------------
Sub DrowMilestone(row, Column)

    On Error Resume Next

    '描画範囲外
    If IsDrownExit(Column, Column) Then
        Exit Sub
    End If

    Dim shpName As String
    shpName = "Plan" & row
    Set shp = ActiveSheet.Shapes(shpName)
    If shp IsNot Nothing Then
        shp.Delete
    End If

    shpName = "Milestone" & row
    Set shp = ActiveSheet.Shapes(shpName)
    If shp IsNot Nothing Then
        shp.Delete
    End If

    shpName = "taskText" & row
    Set shp = ActiveSheet.Shapes(shpName)
    If shp IsNot Nothing Then
        shp.Delete
    End If
    shpName = "startDateText" & row
    Set shp = ActiveSheet.Shapes(shpName)
    If shp IsNot Nothing Then
        shp.Delete
    End If

    Dim r As Range
    Set r = Range(Cells(row, Column), Cells(row, Column))

    'マイルストーン描画
    ActiveSheet.Shapes.AddShape(msoShapeDiamond, r.Left + r.Width / 3.5, r.Top + r.Height - (r.Height / 2 + 2), 6, 6).Select
    Selection.ShapeRange.Name = shpName

    ' 開始「青」、終了「赤」
    Dim InputStartDatePlan As Range: Set InputStartDatePlan = Range("InputStartDatePlan")
    If Cells(row, InputStartDatePlan.Column).Value <> "" Then
        ColorText = Worksheets(SettingSheet).Range("E8").Value
    Else
        ColorText = Worksheets(SettingSheet).Range("E9").Value
    End If
    Select Case ColorText
        Case "黒"
            SetColor = vbBlack
        Case "青"
            SetColor = vbBlue
        Case "シアン"
            SetColor = vbCyan
        Case "緑"
            SetColor = vbGreen
        Case "マゼンタ"
            SetColor = vbMagenta
        Case "赤"
            SetColor = vbRed
        Case "黄"
            SetColor = vbYellow
    End Select

    Selection.ShapeRange.Fill.ForeColor.RGB = SetColor
    Selection.ShapeRange.Line.ForeColor.RGB = SetColor

    ' マイルストーン名を表示する
    shpName = "MilestoneName" & row
    Set shp = ActiveSheet.Shapes(shpName)
    If shp IsNot Nothing Then
        shp.Delete
    End If
    ActiveSheet.Shapes.AddTextbox(msoShapeRectangle, r.Left + r.Width / 2, r.Top, 1024, r.Height).Select
    Selection.ShapeRange.Name = shpName
    strText = Cells(row, 2).Value
    Selection.ShapeRange.TextFrame.Characters.Text = strText
    Selection.ShapeRange.TextFrame.HorizontalAlignment = xlHAlignLeft
    Selection.ShapeRange.Characters.Font.Size = 9
    Selection.ShapeRange.Characters.Font.Bold = True
    Selection.ShapeRange.Line.Visible = msoFalse
    Selection.ShapeRange.Fill.Visible = msoFalse

    Set shp = Nothing
End Sub

'-------------------------------------------------------------------------
' 描画なしの判断
'-------------------------------------------------------------------------
Function IsDrownExit(startColumn, endColumn) As Boolean
    IsDrownExit = False
    Dim DateArea As Range
    Set DateArea = Range("DateArea")

    '開始カラムが描画範囲外
    If startColumn < DateArea.Column Or endColumn < DateArea.Column Then
        IsDrownExit = True
        Exit Function
    End If

    Dim endDateCell As Range
    Set endDateCell = Range("EndDate")
    If startColumn > endDateCell.Column Or endColumn > endDateCell.Column Then
        IsDrownExit = True
        Exit Function
    End If

    Set DateArea = Nothing
    Set endDateCell = Nothing
End Function

'-------------------------------------------------------------------------
' イナズマ線を描画する
'-------------------------------------------------------------------------
Sub DorwInazuma(TodayColumn)

    On Error Resume Next

    'イナズマ線を削除する
    Call ClearInazuma

    '当日カラムが描画範囲外の場合、イナズマ線の描画は行わない
    Dim DateArea As Range: Set DateArea = Range("DateArea")
    Dim endDateCell As Range: Set endDateCell = Range("EndDate")

    If TodayColumn < DateArea.Column Or TodayColumn > endDateCell.Column Then
        Exit Sub
    End If

    'FreeformBuilderオブジェクトを宣言
    Dim InazumaLine As FreeformBuilder

    Dim task As Range: Set task = Range("StartTaskRow")
    Dim row As Integer: row = task.row
    Dim col As Integer: col = TodayColumn + 1
    '進捗率
    Dim rate As Range: Set rate = Range("ProgressRate")

    '項番
    Dim No As Range: Set No = Range("No")

    '予実入力カラム
    Dim InputStartDatePlan As Range: Set InputStartDatePlan = Range("InputStartDatePlan")
    Dim InputEndDatePlan As Range: Set InputEndDatePlan = Range("InputEndDatePlan")

    '開始エリアセル
    Dim StartDateArea As Range: Set StartDateArea = Range("DateArea")
    '終了エリアセル
    Dim EndDateArea As Range: Set EndDateArea = Range("EndDate")

    '始点を設定
    Set InazumaLine = ActiveSheet.Shapes.BuildFreeform(msoEditingAuto, _
        Cells(DateArea.row, TodayColumn + 1).Left, Cells(DateArea.row, TodayColumn + 1).Top)

    '当日カラム
    Dim leftCol As Integer: leftCol = TodayColumn

    '以降の点を結んでいく
    '繰り返し用変数i
    Dim i As Integer

    ' 上から下にセルをなめていく。0以外の数値ならイナズマ線を引く
    Do While Cells(row, No.Column) <> ""

        '進捗描画アドレスを計算する
        Dim x As Double    '進捗描画アドレス

        '予定カラム計算
        Call getDateColumn(Cells(row, InputStartDatePlan.Column).Value, Cells(row, InputEndDatePlan.Column).Value, c1, c2, Today)

        '項目未入力の場合
        If Cells(row, task.Column) = "" Then
            x = 0

        '予定が入力されていない場合、進捗=0
        ElseIf Cells(row, InputStartDatePlan.Column).Value = "" Or Cells(row, InputEndDatePlan.Column).Value = "" Then
            x = 0

        '進捗率未入力の場合
        ElseIf Cells(row, rate.Column).Value = "" Or Cells(row, rate.Column).Value = 0 Then
            If Cells(row, InputStartDatePlan.Column).Value <= Cells(DateArea.row, TodayColumn).Value Then
                x = Cells(row, c1).Left
            Else
                x = 0
            End If
        '進捗率≧100%の場合
        ElseIf Cells(row, rate.Column).Value >= 1 Then
            If Cells(row, InputEndDatePlan.Column).Value > Cells(DateArea.row, TodayColumn).Value Then
                x = Cells(row, c2 + 1).Left
            Else
                x = 0
            End If

        '進捗率<100%の場合
        Else
            Dim d As Double    '計画日数
            Dim d3 As Double   '進捗率より計算される実績進捗カラム

            d = Cells(row, c2 + 1).Left - Cells(row, c1).Left
            d3 = d * Cells(row, rate.Column).Value
            x = d3 + Cells(row, c1).Left
        End If

        '数値以外はスキップ
        If Not IsNumeric(x) Then
        '0もスキップ
        ElseIf x = 0 Then
        'イナズマ線を引く（正の数なら＞、負の数なら＜）
        Else
            '描画範囲外チェック
            If Cells(row, StartDateArea.Column).Left > x Then
                x = Cells(row, StartDateArea.Column).Left
            End If
            If Cells(row, EndDateArea.Column + 1).Left < x Then
                x = Cells(row, EndDateArea.Column + 1).Left
            End If

            InazumaLine.AddNodes msoSegmentLine, msoEditingAuto, _
                Cells(row, TodayColumn + 1).Left, _
                Cells(row, TodayColumn + 1).Top

            ' y軸計算式修正
            InazumaLine.AddNodes msoSegmentLine, msoEditingAuto, _
                x, _
                Cells(row, TodayColumn + 1).Top + (Cells(row + 1, TodayColumn + 1).Top - Cells(row, TodayColumn + 1).Top) / 2
            InazumaLine.AddNodes msoSegmentLine, msoEditingAuto, _
                Cells(row, TodayColumn + 1).Left, _
                Cells(row + 1, TodayColumn + 1).Top
        End If

        '次の行
        row = row + 1
    Loop

    '終点を設定
    InazumaLine.AddNodes msoSegmentLine, msoEditingAuto, _
                Cells(row, TodayColumn + 1).Left, _
                Cells(row, TodayColumn + 1).Top
    'イナズマ線を描画
    InazumaLine.ConvertToShape.Select

    '見た目の編集
    With Selection.ShapeRange.Line
        .ForeColor.RGB = RGB(255, 0, 0)
        .Weight = 1.5
    End With

    Selection.ShapeRange.Name = "InazumaLine"

End Sub

'
' イナズマ線のクリア
'
Sub ClearInazuma()

    On Error Resume Next

    ' 同じ名前のイナズマ線が残っている場合の対応
    For i = 0 To 3
        Set shp = ActiveSheet.Shapes("InazumaLine")
        If shp IsNot Nothing Then
            shp.Delete
        End If
        Set shp = Nothing
    Next
End Sub


Sub DorwInazumaCmd()

    Dim Today As Integer
    Dim DateArea As Range
    Set DateArea = Range("DateArea")
    Today = Date - DateArea + DateArea.Column
    Call DorwInazuma(Today)
End Sub


Sub SelectionCopy()
'
' タスク書式コピー
'

    Worksheets(ChartSheet).Select

    '現在のセル位置を記憶
    selCol = ActiveCell.Column
    selRow = ActiveCell.row

    Range("B4:H1003").Select
    Selection.Copy

    'セル位置を元の位置に戻す
    Cells(selRow, selCol).Select

    Worksheets(InfoSheet).Select
    Range("B3").Select

    ' 全コピー
    DoEvents
    Selection.PasteSpecial Paste:=xlPasteAll, Operation:=xlNone, _
        SkipBlanks:=False, Transpose:=False

    Application.CutCopyMode = False

    ' 書式ロック設定
    Columns("B:H").Select
    Selection.Locked = True

    Range("A1").Select
End Sub

' 進捗率コピー
' 進捗詳細シートから進捗管理シートにコピーする
'
Sub ProgressCopy()

    Worksheets(InfoSheet).Unprotect

    Sheets(InfoSheet).Select
    Range("I3:I1003").Select
    Selection.Copy
    Sheets(ChartSheet).Select
    Range("I4").Select

    ' 値コピー
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, _
        SkipBlanks:=False, Transpose:=False

    Application.CutCopyMode = False
    Columns("I:I").Select
    Selection.Locked = True

    Range("A1").Select
    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFormattingCells:=True, AllowFormattingColumns:=True, _
        AllowFormattingRows:=True, AllowFiltering:=True
End Sub

'-------------------------------------------------------------------------
' 進捗詳細シート Change イベント
'-------------------------------------------------------------------------
Sub ProgressChange(ByVal Target As Range)

    Worksheets(InfoSheet).Unprotect
    Worksheets(InfoSheet).Select

    Dim arr() As String
    ReDim Preserve arr(0)

    For Each c In Target
        If c.row > 2 Then
            '処理済行はスキップ
            strNames = Filter(arr, c.row)
            If UBound(strNames) < 0 Then

                Dim col As Integer
                Dim Plan As Variant
                Dim Weight As Variant
                Dim WeightTotal As Integer: WeightTotal = 0
                For i = 1 To 5
                    col = 10 + (i - 1) * 4
                    Plan = Cells(c.row, col).Value
                    If Plan <> "" Then
                        Weight = Cells(c.row, col + 2).Value
                        If Weight < 1 Then Weight = 100
                        If Weight > 100 Then Weight = 100
                        Cells(c.row, col + 2).Value = Weight
                        WeightTotal = WeightTotal + Weight
                    End If
                Next i

                Dim ProgressTotal As Double: ProgressTotal = 0#
                For i = 1 To 5
                    col = 10 + (i - 1) * 4
                    Plan = Cells(c.row, col).Value
                    Dim Achievement As Variant: Achievement = Cells(c.row, col + 1).Value
                    Weight = Cells(c.row, col + 2).Value
                    Dim Progress As Variant: Progress = 0
                    If Plan <> "" Then
                        Cells(c.row, col + 2).Value = Weight
                        Progress = Achievement / Plan
                        If Progress > 1 Then Progress = 1
                        ProgressTotal = ProgressTotal + Progress * (Weight / WeightTotal)
                        Cells(c.row, col + 3).Value = Progress * (Weight / WeightTotal)
                    Else
                        Cells(c.row, col + 3).Value = ""
                    End If
                Next i

                Cells(c.row, 9).Value = ProgressTotal

                If Cells(c.row, 9).Value > 0 And Cells(c.row, 7).Value = "" Then
                    Worksheets(ChartSheet).Cells(c.row + 1, 7).Value = Date
                    Worksheets(InfoSheet).Cells(c.row, 7).Value = Worksheets(ChartSheet).Cells(c.row + 1, 7).Value
                End If
                If Cells(c.row, 9).Value >= 1 And Cells(c.row, 8).Value = "" Then
                    Worksheets(ChartSheet).Cells(c.row + 1, 8).Value = Date
                    Worksheets(InfoSheet).Cells(c.row, 8).Value = Worksheets(ChartSheet).Cells(c.row + 1, 8).Value
                End If
                If Cells(c.row, 9).Value < 1 Then
                    Worksheets(ChartSheet).Cells(c.row + 1, 8).Value = ""
                    Worksheets(InfoSheet).Cells(c.row, 8).Value = ""
                End If

                If Cells(c.row, 9).Value <> Worksheets(ChartSheet).Cells(c.row + 1, 9) Then
                    Worksheets(ChartSheet).Select

                    Application.EnableEvents = True     'イベント発生有効化
                    Application.ScreenUpdating = True   '描画の有効化
                    Worksheets(ChartSheet).Cells(c.row + 1, 9) = Worksheets(InfoSheet).Cells(c.row, 9).Value
                    Application.EnableEvents = False    'イベント発生無効化
                    Application.ScreenUpdating = False  '描画の無効化

                    Worksheets(InfoSheet).Select
                End If
                arr(UBound(arr)) = c.row
            End If
        End If
    Next c

    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFormattingCells:=True, AllowFormattingColumns:=True, _
        AllowFormattingRows:=True, AllowFiltering:=True
End Sub

'-------------------------------------------------------------------------
' 列表示位置を初期化
'-------------------------------------------------------------------------
Sub ColumnDisplayInit()

On Error GoTo ErrLabel
    Dim Today As Integer
    Set DateArea = Range("DateArea")
    Today = Date - DateArea + DateArea.Column

    ' 当日が期間範囲外の場合、エラースキップ
    If Today < DateArea.Column Then
        Today = Range("DateArea").Column + 7
    End If
    If Today > Range("EndDate").Column Then
        Today = Range("EndDate").Column
    End If

    ' シートの左端にくる列番号を設定する
    ActiveWindow.ScrollColumn = Today - 7
    Exit Sub

ErrLabel:
'無処理
End Sub

'-------------------------------------------------------------------------
' 開始日、終了日が逆転していたら入れ替える
'-------------------------------------------------------------------------
Sub ChangeDate(row, startCloumn, endCloumn)

    If Cells(row, startCloumn).Value <> "" And Cells(row, endCloumn).Value <> "" Then
        If Cells(row, startCloumn).Value > Cells(row, endCloumn).Value Then
            wk = Cells(row, startCloumn).Value
            Cells(row, startCloumn).Value = Cells(row, endCloumn).Value
            Cells(row, endCloumn).Value = wk
        End If
    End If
End Sub

'-------------------------------------------------------------------------
' ガンチャートの更新処理
'-------------------------------------------------------------------------
Sub DrawPlanCmd()
    On Error GoTo handleError

    Application.Cursor = xlWait
    Application.StatusBar = "処理中です"
    Application.EnableCancelKey = xlDisabled
    Application.EnableEvents = False    'イベント発生無効化

    'ツールバーの追加
    Call AddToolber

    '図形消去
    Call ClearShapes

    '進捗管理シートを選択
    Worksheets(ChartSheet).Select

    ActiveSheet.Range("D1").Value = Version

    Dim setDate As String
    setDate = Worksheets(SettingSheet).Range("E5").Value
    If IsDate(setDate) Then
        ActiveSheet.Range("DateArea").Value = setDate
    Else
        ActiveSheet.Range("DateArea").Value = DateSerial(Year(Date), 1, 1)
    End If

    '進捗率 直接入力
    Call UnprotectActiveWorkbook
    Call UnprotectChartSheet

    If Worksheets(SettingSheet).Range("E10").Value = C_YES Then
        Call ProgressUnLock
        Call InfoSheetNoneDisplay
    Else
        Call ProgressLock
        Call InfoSheetDisplay
    End If

    'ガンチャートの描画
    Call DrawPlan
    'イナズマ線の描画
    Call DorwInazumaEx
    'カラム表示位置初期化
    Call ColumnDisplayInit

    Call ProtectChartSheet
    Call ProtectActiveWorkbook

    Application.EnableEvents = True     'イベント発生有効化
    Application.EnableCancelKey = xlInterrupt
    Application.StatusBar = False
    Application.Cursor = xlDefault
End Sub

'-------------------------------------------------------------------------
' ブックの保護
'-------------------------------------------------------------------------
Sub ProtectActiveWorkbook()
    ActiveWorkbook.Protect Password:="penguin@0401", Structure:=True, Windows:=False
End Sub

'-------------------------------------------------------------------------
' ブックの保護解除
'-------------------------------------------------------------------------
Sub UnprotectActiveWorkbook()
    ActiveWorkbook.Unprotect ("penguin@0401")
End Sub

'-------------------------------------------------------------------------
' 進捗セルのアンロック
'-------------------------------------------------------------------------
Sub ProgressUnLock()
    Dim ws As Worksheet
    Set ws = ActiveSheet

    Worksheets(ChartSheet).Select

    selCol = ActiveCell.Column
    selRow = ActiveCell.row

    Range("I4:I1003").Select
    Selection.Locked = False
    Selection.FormulaHidden = False

    Cells(selRow, selCol).Select

    Worksheets(ws.Name).Select
End Sub

'-------------------------------------------------------------------------
' 進捗セルのロック
'-------------------------------------------------------------------------
Sub ProgressLock()
    Dim ws As Worksheet
    Set ws = ActiveSheet

    Worksheets(ChartSheet).Select

    selCol = ActiveCell.Column
    selRow = ActiveCell.row

    Range("I4:I1003").Select
    Selection.Locked = True
    Selection.FormulaHidden = False

    Cells(selRow, selCol).Select

    Worksheets(ws.Name).Select
End Sub

'-------------------------------------------------------------------------
' 「進捗詳細」シート表示
'-------------------------------------------------------------------------
Sub InfoSheetDisplay()
    Worksheets(InfoSheet).Visible = True
End Sub

'-------------------------------------------------------------------------
' 「進捗詳細」シート非表示
'-------------------------------------------------------------------------
Sub InfoSheetNoneDisplay()
    Worksheets(InfoSheet).Visible = False
End Sub

'-------------------------------------------------------------------------
' 「進捗管理」シートの保護
'-------------------------------------------------------------------------
Sub ProtectChartSheet()
    Worksheets(ChartSheet).Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFormattingCells:=True, AllowFormattingColumns:=True, _
        AllowFormattingRows:=True, AllowFiltering:=True
End Sub

'-------------------------------------------------------------------------
' 「進捗管理」シートの保護解除
'-------------------------------------------------------------------------
Sub UnprotectChartSheet()
    Worksheets(ChartSheet).Unprotect
End Sub

'-------------------------------------------------------------------------
' ツールバーの登録
'-------------------------------------------------------------------------
Sub AddToolber()
On Error GoTo handleError

    Dim xlAPP As Application
    Dim objBar As CommandBar
    Dim objCont As CommandBarControl
    Dim objBtn As CommandBarButton
    Dim vntCaption As Variant
    Dim vntTipText As Variant
    Dim vntOnAction As Variant
    Dim IX As Integer
    Dim blnTRUE As Boolean

    Set xlAPP = Application

    ' ボタンのタイトルを設定
    vntCaption = Array("ガンチャート更新(&U)")              ' ・
    ' ボタンにマウスを当てた時に表示されるテキストを設定
    vntTipText = Array("ガンチャート更新を行ないます")
    ' ボタンの動作マクロを指定
    vntOnAction = Array("DrawPlan")

    ' ツールバーを追加する
    Set objBar = xlAPP.CommandBars.Add(Name:=g_cnsTITLE, Position:=msoBarTop)
    ' 1番目はボタンの境界をなしにする
    blnTRUE = False
    ' ボタンを3つ追加する
    For IX = 0 To 0
        ' まずボタンを指定してコントロールを追加
        Set objCont = objBar.Controls.Add(Type:=msoControlButton)
        ' ボタンの境界を設定
        objCont.BeginGroup = blnTRUE
        ' CommandBarButtonオブジェクトの参照を取得
        Set objBtn = objCont
        objBtn.Style = msoButtonCaption         ' ボタン名を表示
        objBtn.Caption = vntCaption(IX)         ' 表示名を設定
        objBtn.TooltipText = vntTipText(IX)     ' マウスを当てた時のツールチップテキスト
        objBtn.OnAction = vntOnAction(IX)       ' 動作マクロを設定
        ' 2番目以降はボタンの境界を設定
        blnTRUE = True
    Next IX
    ' ツールバーを表示する
    objBar.Visible = True
    ' ツールバーを非表示にできなくする
    objBar.Protection = msoBarNoChangeVisible
    ActiveWindow.ScrollRow = 1

handleError:
    ' オブジェクトの参照を廃棄
    Set objBtn = Nothing
    Set objCont = Nothing
    Set objBar = Nothing
End Sub

'
' ステータスバーに処理中メッセージを表示する
'
Sub ProcessingMessage(stat As Boolean)

    Select Case stat
    Case True
        Application.Cursor = xlWait
        Application.StatusBar = "処理中です。しばらくお待ちください。"
        Application.EnableCancelKey = xlDisabled

    Case False
        Application.EnableCancelKey = xlInterrupt
        Application.StatusBar = False
        Application.Cursor = xlDefault
    End Select
End Sub

'-------------------------------------------------------------------------
' 稼働日の計算
'-------------------------------------------------------------------------
Function WorkingDayCalculation(startdate, endDate) As Double

    Dim weekFlg As String
    Dim week As Long
    Dim holidays  As Range
    Dim holidayRow As Long

    holidayRow = Sheets(SettingSheet).Cells(Rows.Count, 1).End(xlUp).row
    Set holidays = Range(Sheets(SettingSheet).Cells(3, 1), Sheets(SettingSheet).Cells(holidayRow, 1))
    weekFlg = "00000"
    '土曜日を休日とする場合
    If Worksheets(SettingSheet).Range("E3").Value = C_YES Then
        weekFlg = weekFlg & "1"
    Else
        weekFlg = weekFlg & "0"
    End If
    '日曜日を休日とする場合
    If Worksheets(SettingSheet).Range("E4").Value = C_YES Then
        weekFlg = weekFlg & "1"
    Else
        weekFlg = weekFlg & "0"
    End If

    WorkingDayCalculation = WorksheetFunction.NetworkDays_Intl(startdate, endDate, weekFlg, holidays)
End Function

'-------------------------------------------------------------------------
' Module2
'-------------------------------------------------------------------------

Sub ProtectChartSheet()
'
' 「進捗管理」シートの保護
'

    Worksheets(ChartSheet).Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFormattingCells:=True, AllowFormattingColumns:=True, _
        AllowFormattingRows:=True, AllowFiltering:=True

End Sub

Sub UnprotectChartSheet()
'
' 「進捗管理」シートの保護解除
'

    Worksheets(ChartSheet).Unprotect

End Sub

Sub ProtectActiveWorkbook()
'
'ブックの保護
    ActiveWorkbook.Protect Password:="penguin@0401", Structure:=True, Windows:=False
'

End Sub



Sub UnprotectActiveWorkbook()
'
'ブックの保護解除
'
    ActiveWorkbook.Unprotect ("penguin@0401")

End Sub



Sub ProgressUnLock()
'
' 進捗セルのアンロック
'
    'アクティブシートを取得
    Dim ws As Worksheet
    Set ws = ActiveSheet

    '進捗管理シートを選択
    Worksheets(ChartSheet).Select

    '現在のセル位置を記憶
    selCol = ActiveCell.Column
    selRow = ActiveCell.row

    Range("I4:I1003").Select
    Selection.Locked = False
    Selection.FormulaHidden = False

    'セル位置を元の位置に戻す
    Cells(selRow, selCol).Select

    'アクティブシート設定
    Worksheets(ws.Name).Select


End Sub

Sub ProgressLock()
'
' 進捗セルのロック
'
    'アクティブシートを取得
    Dim ws As Worksheet
    Set ws = ActiveSheet

    '進捗管理シートを選択
    Worksheets(ChartSheet).Select

    '現在のセル位置を記憶
    selCol = ActiveCell.Column
    selRow = ActiveCell.row

    Range("I4:I1003").Select
    Selection.Locked = True
    Selection.FormulaHidden = False

    'セル位置を元の位置に戻す
    Cells(selRow, selCol).Select

    'アクティブシート設定
    Worksheets(ws.Name).Select


End Sub

Sub InfoSheetDisplay()
'
' 「進捗詳細」シート表示
'
    Worksheets(InfoSheet).Visible = True

End Sub

Sub InfoSheetNoneDisplay()
'
' 「進捗詳細」シート非表示
'
    Worksheets(InfoSheet).Visible = False
End Sub




```
